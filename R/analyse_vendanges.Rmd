---
title: "Analyse vendanges DADS"
author: "Thomas Vroylandt"
date: "28/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(here)
library(gganimate)

```


```{r import_clean}
# Import - filtre à intégrer en amont
dads_postes <- read_rds(here("data/dads_filtre_05_15.rds")) %>% 
  filter(annee != 2005) %>% 
  mutate(filtre_poste = fct_recode(FILT,
                           "Annexe" = "2",
                           "Non annexe" = "1"),
         filtre_poste = fct_relevel(filtre_poste,
                            "Annexe", "Non annexe"))

# Construction des périodes d'emplois
seq_empl <- dads_postes %>% 
  group_by(annee, DATDEB, DATFIN, filtre_poste) %>% 
  count() %>% 
  mutate(n = n * 12)

seq_empl_jour <- tibble(jour = seq(-30, 360, 1)) %>% 
  mutate(join = "1") %>% 
  full_join((seq_empl %>% 
               mutate(join = "1")),
            by = "join") %>% 
  mutate(ind_ok = case_when(jour >= DATDEB & jour <= DATFIN ~ "1",
                            TRUE ~ "0")) %>% 
  filter(ind_ok == "1") %>% 
  group_by(annee, jour, filtre_poste) %>% 
  summarise(n = sum(n))  %>% 
  filter(jour > 0)
```

```{r moyenne_10ans}
# Moyennes sur 10 ans
moy_empl <- dads_postes %>% 
  group_by(filtre_poste) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(part_empl = n / sum(n) * 100)

moy_jour <- seq_empl_jour %>% 
  group_by(filtre_poste) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() %>% 
  mutate(part_jour = n / sum(n) * 100)

moy_10ans <- moy_empl %>% 
  left_join(moy_jour, by = ("filtre_poste")) %>% 
  mutate_at(vars(part_empl, part_jour), format, 
            decimal.mark = ",", digits = 0, nsmall = 0) %>% 
  select(filtre_poste, part_empl, part_jour)
```

Tisser un peu le récit (référence littéraire ? style journalistique ?)

Intro sur qui compose la PCS au niveau métier, combien d'emploi (postes) cela représente + renvoi à la note méthodologique de fin.

691D : Ouvriers de la viticulture ou de l'arboriculture fruitière

## Emplois permanents et saisonniers

Au sein de la profession des ouvriers viticoles et arboriculteurs, deux modalités d'emploi se dessinent :

+ d'un côté des emplois permanents (ou poste non-annexe), à l'année ou sur des périodes longues. En moyenne, sur 10 ans, ils représentent `r filter(moy_10ans, filtre_poste == "Non annexe")$part_empl` % des emplois et `r filter(moy_10ans, filtre_poste == "Non annexe")$part_jour` % des jours travaillés ;
+ de l'autre côté des emplois saisonniers (ou poste annexe), sur de courtes périodes, pour les récoltes. De façon, inverse, ils représentent la majorité des emplois, `r filter(moy_10ans, filtre_poste == "Annexe")$part_empl` %, mais seulement `r filter(moy_10ans, filtre_poste == "Annexe")$part_jour` % des jours travaillés.

## Analyse de la saisonnalité

De façon assez logique, ces emplois ne se répartissent pas de la même façon au cours de l'année. Les emplois permanents sont de faits relativement stables selon les périodes, bien qu'on observe un pic au moment des récoltes. Les emplois saisonniers se multiplient au moment des périodes de récolte et notamment pendant les vendanges.

```{r saisonnalite_poste, fig.height=7, fig.width=12}
# Saisonnalité en fonction du type de poste, en moyenne décennale
seq_empl_jour %>%
  group_by(jour, filtre_poste) %>%
  summarise(n = sum(n)) %>%
  ungroup() %>%
  mutate(part_n = n / sum(n)) %>%
  ggplot() +
  geom_area(aes(x = jour / 30, y = part_n * 100, fill = filtre_poste),
            stat = "identity") +
  geom_label(
    data = tibble(x = 4.5, y = 0.4, label = "La période des vendanges, en septembre, est visible ici"),
    aes(
      x = x,
      y = y,
      label = str_wrap(label, 15)
    ),
    label.size = NA
  ) +
  geom_curve(
    data = tibble(
      x = 5,
      xend = 8.45,
      y = 0.45,
      yend = 0.53
    ),
    aes(
      x = x,
      y = y,
      xend = xend,
      yend = yend
    ),
    size = 0.5,
    curvature = -0.1,
    arrow = arrow(length = unit(0.01, "npc"), type = "open")
  ) +
  scale_x_continuous(
    "",
    breaks = seq(0, 11, 1),
    labels = c(
      "Janvier",
      "Février",
      "Mars",
      "Avril",
      "Mai",
      "Juin",
      "Juillet",
      "Août",
      "Septembre",
      "Octobre",
      "Novembre",
      "Décembre"
    )
  ) +
  scale_y_continuous("Part de l'emploi (en %)",
                     breaks = seq(0, 0.7, 0.1),
                     limits = c(0, 0.6)) +
  scale_fill_manual("Type de poste",
                    values = c("#ff4500", "#00baff")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      size = 11,
      vjust = 1,
      angle = 60
    ),
    axis.text.y = element_text(size = 11)
  )

```

```{r diff_emploi}
# % des emplois
dads_postes %>% 
  group_by(annee, filtre_poste) %>% 
  count() %>% 
  group_by(annee) %>% 
  mutate(part_n = n /sum(n)) %>% 
  ungroup()

# On construit des périodes d'emploi
seq_empl <- dads_postes %>% 
  group_by(annee, DATDEB, DATFIN, filtre_poste) %>% 
  count() %>% 
  mutate(n = n * 12)

seq_empl_jour <- tibble(jour = seq(-30, 360, 1)) %>% 
  mutate(join = "1") %>% 
  full_join((seq_empl %>% 
               mutate(join = "1")),
            by = "join") %>% 
  mutate(ind_ok = case_when(jour >= DATDEB & jour <= DATFIN ~ "1",
                            TRUE ~ "0")) %>% 
  filter(ind_ok == "1") %>% 
  group_by(annee, jour, filtre_poste) %>% 
  summarise(n = sum(n))  %>% 
  filter(jour > 0) %>% 
  group_by(annee) %>% 
  mutate(part_n = n / sum(n)) %>% 
  ungroup()

# % des jours travaillés
seq_empl_jour %>% 
  group_by(annee, filtre_poste) %>% 
  summarise(sum(part_n))

# graph
gif_seq_empl_jour <- seq_empl_jour %>% 
  mutate(filtre_poste = fct_recode(filtre_poste,
                           "Annexe" = "2",
                           "Non annexe" = "1"),
         filtre_poste = fct_relevel(filtre_poste,
                            "Annexe", "Non annexe")) %>% 
  ggplot(aes(x = jour, y = part_n * 100, fill = filtre_poste)) +
  geom_area(stat = "identity") +
  transition_time(annee) +
  labs(title = "{frame_time}")

# annee
dads_postes%>% 
  filter(filtre_poste == "2" & annee != 2005) %>% 
  ggplot(aes(x = as.character(annee), y = DATDEB)) +
  geom_boxplot() +
  coord_flip()
```


## Analyse géographique

```{r}
dads_postes%>% 
  filter(filtre_poste == "2" & DEPT %in% c("51", "33", "21", "69", "02", "13")) %>% 
  ggplot(aes(x = DEPT, y = DATDEB)) +
  geom_boxplot() +
  coord_flip()
```


## Analyse démographique

```{r demographie}
dads_demo <- dads_postes %>%
  mutate(AGE_TR = cut(AGE, breaks = c(0, 15, 19, 23, 27, 31, 35, 39, 
                                      43, 47, 51, 55, 59, 63, 67, 71, 150), 
                      include.lowest = TRUE, right = FALSE,
                      labels = c("00", "19", "23", "27", "31", "35", "39",
                                 "43", "47", "51", "55", "59", "63", "67", "71", "72"))) %>% 
  group_by(annee, SEXE, AGE_TR, filtre_poste) %>% 
  count() %>% 
  mutate(n = n * 12) %>% 
  group_by(annee, filtre_poste) %>% 
  mutate(part_n = n / sum(n) * 100,
         part_n = if_else(SEXE == "2", -part_n, part_n)) %>%
  filter(AGE_TR != "00" & !is.na(AGE_TR)) %>% 
  ungroup()

# Fusion
dads_demo %>% 
  ggplot(aes(x = AGE_TR, y = part_n, fill = SEXE)) +
  geom_bar(stat = "identity", position = "dodge", width = 2) +
  coord_flip() +
  facet_grid(rows = vars(annee), cols = vars(filtre_poste))
```


> ## Méthodologie
>
> La déclaration annuelle de données sociales (DADS) est une formalité administrative obligatoire pour toute entreprise employant des salariés. Elle contient des informations relatives à l'établissement et au salarié.
> Ces données sont recueillies par l'Insee qui constitue des fichiers d'analyse. Le fichier utilisé ici est le fichier "postes" où chaque enregistrement correspond à un poste, c'est-à-dire à la consolidation des périodes de travail d'un salarié dans un même établissement.
>
> Un poste est catégorisé en fonction de plusieurs critères pour analyser si il re lève d'un "vrai" emploi ou d'un poste non annexe, par exemple saisonnier ou de très courte durée. Un poste est dit non-annexe si :
>
> + la rémunération nette est supérieure à 3 SMIC mensuels ;
> + ou le nombre d'heures salariées est supérieur à 120 et la durée de travail supérieure à 30 jours.
>
> Dans les autres cas, le poste est considéré comme annexe.
>
> ## Code et analyse
>
> L'ensemble de l'analyse et du code est disponible sur [github](https://github.com/tvroylandt/vendanges).
>
> Les remarques, commentaires et propositions sont les bienvenus : tvroylandt@gmail.com
>

