---
title: "Analyse vendanges DADS"
author: "Thomas Vroylandt"
date: "20/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)

# Import
dads_postes <- read_rds(here("data/dads_filtre_05_15.rds"))
```

## Analyse démographique

```{r demographie, eval = FALSE}
dads_demo <- dads_postes %>%
  mutate(AGE_TR = cut(AGE, breaks = c(0, 15, 19, 23, 27, 31, 35, 39, 
                                      43, 47, 51, 55, 59, 63, 67, 71, 150), 
                      include.lowest = TRUE, right = FALSE,
                      labels = c("00", "19", "23", "27", "31", "35", "39",
                                 "43", "47", "51", "55", "59", "63", "67", "71", "72"))) %>% 
  group_by(annee, SEXE, AGE_TR) %>% 
  count() %>% 
  mutate(n = n * 12) %>% 
  group_by(annee) %>% 
  mutate(part_n = n / sum(n) * 100,
         part_n = if_else(SEXE == "2", -part_n, part_n)) %>%
  filter(AGE_TR != "00" & !is.na(AGE_TR)) %>% 
  ungroup()

# Fusion
dads_demo %>% 
  ggplot(aes(x = AGE_TR, y = part_n, fill = SEXE)) +
  geom_bar(stat = "identity", position = "dodge", width = 2) +
  facet_wrap(vars(annee)) +
  coord_flip()
```

## Analyse géographique

## Analyse de la saisonnalité

```{r saisonnalite}
# On construit des périodes d'emploi
seq_empl <- dads_postes %>% 
  group_by(annee, DATDEB, DATFIN) %>% 
  count() %>% 
  mutate(n = n * 12)

seq_empl_jour <- tibble(jour = seq(-30, 360, 1)) %>% 
  mutate(join = "1") %>% 
  full_join((seq_empl %>% 
               mutate(join = "1")),
            by = "join") %>% 
  mutate(ind_ok = case_when(jour >= DATDEB & jour <= DATFIN ~ "1",
                            TRUE ~ "0")) %>% 
  filter(ind_ok == "1") %>% 
  group_by(annee, jour) %>% 
  summarise(n = sum(n))  %>% 
  filter(jour > 0) %>% 
  group_by(annee) %>% 
  mutate(part_n = n / sum(n)) %>% 
  ungroup()

# graph
seq_empl_jour %>% 
  ggplot(aes(x = jour, y = part_n * 100, color = as.character(annee))) +
  geom_line(lwd = 1)
```

